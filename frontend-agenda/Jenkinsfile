pipeline {
    agent any
    
    environment {
        // Variables de entorno
        APP_NAME = "mi-react-app"
        VERSION = "${env.BRANCH_NAME == 'main' ? env.BUILD_NUMBER : "${env.BRANCH_NAME}-${env.BUILD_NUMBER}"}"
        
        // Configuraci√≥n de la MV
        DEPLOY_SERVER = "192.168.1.100"
        DEPLOY_USER = "deployuser"
        DEPLOY_PATH = "/var/www/html/${APP_NAME}"
        SSH_CREDENTIALS = "vm-ssh-key"
        
        // Variables de build
        NODE_VERSION = '18.x'
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 30, unit: 'MINUTES')
        disableConcurrentBuilds()
        ansiColor('xterm')
    }
    
    stages {
        // Stage 1: Checkout del c√≥digo
        stage('Checkout') {
            steps {
                checkout scm
                script {
                    currentBuild.displayName = "#${env.BUILD_NUMBER} - ${env.GIT_BRANCH}"
                    currentBuild.description = "Commit: ${env.GIT_COMMIT.take(8)}"
                }
            }
        }
        
        // Stage 2: Setup Node.js
        stage('Setup Node.js') {
            steps {
                script {
                    // Instalar Node.js version espec√≠fica
                    sh """
                        curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION} | sudo -E bash -
                        sudo apt-get install -y nodejs
                    """
                    
                    // Verificar versiones
                    sh 'node --version'
                    sh 'npm --version'
                }
            }
        }
        
        // Stage 3: Instalar dependencias
        stage('Install Dependencies') {
            steps {
                sh 'npm ci --prefer-offline --no-audit'
                
                // Cache de node_modules para builds futuros
                script {
                    if (fileExists('node_modules')) {
                        stash name: 'node_modules', includes: 'node_modules/**/*'
                    }
                }
            }
        }
        
        // Stage 4: Linting y an√°lisis de c√≥digo
        stage('Code Quality') {
            parallel {
                stage('ESLint') {
                    steps {
                        sh 'npm run lint || true'  // Contin√∫a aunque falle el linting
                    }
                    
                    post {
                        always {
                            recordIssues(
                                tools: [esLint(pattern: '**/eslint-report.xml')],
                                qualityGates: [[threshold: 1, type: 'TOTAL', unstable: true]]
                            )
                        }
                    }
                }
                
                stage 'Security Audit' {
                    steps {
                        sh 'npm audit --audit-level moderate || true'  // No falla el build por warnings
                    }
                }
            }
        }
        
        // Stage 5: Testing
        stage('Test') {
            parallel {
                stage('Unit Tests') {
                    steps {
                        sh 'npm test -- --coverage --watchAll=false --passWithNoTests'
                    }
                    
                    post {
                        always {
                            junit 'reports/junit/*.xml'
                            
                            // Reporte de cobertura
                            publishHTML(
                                target: [
                                    allowMissing: true,
                                    alwaysLinkToLastBuild: false,
                                    keepAll: true,
                                    reportDir: 'coverage/lcov-report',
                                    reportFiles: 'index.html',
                                    reportName: 'Test Coverage Report'
                                ]
                            )
                        }
                    }
                }
                
                stage('Build Verification') {
                    steps {
                        sh 'npm run build'
                    }
                }
            }
        }
        
        // Stage 6: Build de producci√≥n
        stage('Build Production') {
            steps {
                sh 'npm run build'
                
                // Crear archivo de versi√≥n
                sh """
                    echo "Build: ${VERSION}" > build/version.txt
                    echo "Branch: ${env.BRANCH_NAME}" >> build/version.txt
                    echo "Commit: ${env.GIT_COMMIT}" >> build/version.txt
                    echo "Date: \$(date)" >> build/version.txt
                """
                
                // Archivar build
                archiveArtifacts artifacts: 'build/**/*', fingerprint: true
            }
        }
        
        // Stage 7: An√°lisis de bundle
        stage('Bundle Analysis') {
            steps {
                script {
                    try {
                        sh 'npm install --save-dev webpack-bundle-analyzer'
                        sh 'npm run build -- --profile --json > build/stats.json'
                        
                        // Generar reporte de an√°lisis
                        sh 'npx webpack-bundle-analyzer build/stats.json build/ -r report.html'
                        
                        publishHTML(
                            target: [
                                allowMissing: true,
                                alwaysLinkToLastBuild: false,
                                keepAll: true,
                                reportDir: '.',
                                reportFiles: 'report.html',
                                reportName: 'Bundle Analysis Report'
                            ]
                        )
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è Bundle analysis skipped: ${e.message}"
                    }
                }
            }
        }
        
        // Stage 8: Preparar despliegue
        stage('Prepare Deployment') {
            when {
                expression { 
                    return env.BRANCH_NAME == 'main' || env.BRANCH_NAME == 'develop' 
                }
            }
            
            steps {
                script {
                    // Crear script de despliegue
                    sh """
                        cat > deploy.sh << 'EOF'
                        #!/bin/bash
                        set -e
                        
                        APP_NAME="${APP_NAME}"
                        DEPLOY_PATH="${DEPLOY_PATH}"
                        BACKUP_DIR="\${DEPLOY_PATH}/backups"
                        
                        echo "üöÄ Iniciando despliegue de React app..."
                        
                        # Crear directorios si no existen
                        sudo mkdir -p \${DEPLOY_PATH}
                        sudo mkdir -p \${BACKUP_DIR}
                        sudo chown -R ${DEPLOY_USER}:${DEPLOY_USER} \${DEPLOY_PATH}
                        
                        # Backup del deploy actual
                        if [ -d "\${DEPLOY_PATH}/current" ]; then
                            TIMESTAMP=\$(date +%Y%m%d_%H%M%S)
                            sudo cp -r "\${DEPLOY_PATH}/current" "\${BACKUP_DIR}/\${TIMESTAMP}"
                            echo "‚úÖ Backup creado: \${BACKUP_DIR}/\${TIMESTAMP}"
                        fi
                        
                        # Copiar nuevo build
                        echo "üì¶ Copiando nueva versi√≥n..."
                        sudo rm -rf "\${DEPLOY_PATH}/new_build"
                        sudo cp -r build "\${DEPLOY_PATH}/new_build"
                        
                        # Cambiar ownership
                        sudo chown -R www-data:www-data "\${DEPLOY_PATH}/new_build"
                        sudo chmod -R 755 "\${DEPLOY_PATH}/new_build"
                        
                        # Switch al nuevo build (atomic deploy)
                        echo "üîÑ Realizando deploy at√≥mico..."
                        sudo rm -rf "\${DEPLOY_PATH}/old_build"
                        if [ -d "\${DEPLOY_PATH}/current" ]; then
                            sudo mv "\${DEPLOY_PATH}/current" "\${DEPLOY_PATH}/old_build"
                        fi
                        sudo mv "\${DEPLOY_PATH}/new_build" "\${DEPLOY_PATH}/current"
                        sudo rm -rf "\${DEPLOY_PATH}/old_build"
                        
                        # Configurar Nginx si es necesario
                        if [ ! -f "/etc/nginx/sites-enabled/\${APP_NAME}" ]; then
                            echo "‚ö†Ô∏è  Configuraci√≥n de Nginx no encontrada, creando..."
                            sudo bash -c 'cat > /etc/nginx/sites-available/\${APP_NAME} << NGINX_CONFIG
                        server {
                            listen 80;
                            server_name ${DEPLOY_SERVER};
                            root \${DEPLOY_PATH}/current;
                            index index.html;
                            
                            location / {
                                try_files \\$uri \\$uri/ /index.html;
                            }
                            
                            # Cache est√°ticos
                            location ~* \\.(js|css|png|jpg|jpeg|gif|ico|svg|woff2)$ {
                                expires 1y;
                                add_header Cache-Control "public, immutable";
                            }
                        }
                        NGINX_CONFIG'
                            
                            sudo ln -sf /etc/nginx/sites-available/\${APP_NAME} /etc/nginx/sites-enabled/
                            sudo nginx -t && sudo systemctl reload nginx
                        fi
                        
                        echo "‚úÖ Despliegue completado exitosamente!"
                        EOF
                        
                        chmod +x deploy.sh
                    """
                }
            }
        }
        
        // Stage 9: Desplegar en MV
        stage('Deploy to VM') {
            when {
                expression { 
                    return env.BRANCH_NAME == 'main' || env.BRANCH_NAME == 'develop' 
                }
            }
            
            steps {
                script {
                    def environment = env.BRANCH_NAME == 'main' ? 'production' : 'staging'
                    def port = env.BRANCH_NAME == 'main' ? '80' : '8080'
                    
                    echo "üöÄ Desplegando en ${environment} (${DEPLOY_SERVER}:${port})"
                    
                    sshagent([SSH_CREDENTIALS]) {
                        // Crear directorio remoto si no existe
                        sh """
                            ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_SERVER} \
                                "sudo mkdir -p ${DEPLOY_PATH} && sudo chown ${DEPLOY_USER} ${DEPLOY_PATH}"
                        """
                        
                        // Copiar build y script de despliegue
                        sh """
                            scp -o StrictHostKeyChecking=no -r build/ ${DEPLOY_USER}@${DEPLOY_SERVER}:${DEPLOY_PATH}/temp_build/
                            scp -o StrictHostKeyChecking=no deploy.sh ${DEPLOY_USER}@${DEPLOY_SERVER}:${DEPLOY_PATH}/
                        """
                        
                        // Ejecutar script de despliegue
                        sh """
                            ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_SERVER} \
                                "cd ${DEPLOY_PATH} && chmod +x deploy.sh && ./deploy.sh"
                        """
                    }
                }
            }
        }
        
        // Stage 10: Smoke Tests
        stage('Smoke Tests') {
            when {
                expression { 
                    return env.BRANCH_NAME == 'main' || env.BRANCH_NAME == 'develop' 
                }
            }
            
            steps {
                script {
                    def protocol = env.BRANCH_NAME == 'main' ? 'https' : 'http'
                    def url = "${protocol}://${DEPLOY_SERVER}"
                    
                    echo "üß™ Ejecutando smoke tests en: ${url}"
                    
                    // Tests de humo b√°sicos
                    sh """
                        # Esperar que el deploy est√© completo
                        sleep 10
                        
                        # Verificar que la aplicaci√≥n carga
                        if curl -f ${url} > /dev/null 2>&1; then
                            echo "‚úÖ La aplicaci√≥n responde correctamente"
                        else
                            echo "‚ùå La aplicaci√≥n no responde"
                            exit 1
                        fi
                        
                        # Verificar que el bundle JS se carga
                        if curl -f ${url}/static/js/main.*.js > /dev/null 2>&1; then
                            echo "‚úÖ Los archivos est√°ticos se sirven correctamente"
                        else
                            echo "‚ùå Error cargando archivos est√°ticos"
                            exit 1
                        fi
                    """
                }
            }
        }
        
        // Stage 11: Lighthouse Audit (solo production)
        stage('Lighthouse Audit') {
            when {
                expression { 
                    return env.BRANCH_NAME == 'main' 
                }
            }
            
            steps {
                script {
                    try {
                        sh 'npm install -g lighthouse'
                        sh """
                            lighthouse http://${DEPLOY_SERVER} \
                                --output html --output-path ./lighthouse-report.html \
                                --chrome-flags="--headless --no-sandbox" \
                                --only-categories=performance,accessibility,best-practices,seo
                        """
                        
                        publishHTML(
                            target: [
                                allowMissing: true,
                                alwaysLinkToLastBuild: false,
                                keepAll: true,
                                reportDir: '.',
                                reportFiles: 'lighthouse-report.html',
                                reportName: 'Lighthouse Report'
                            ]
                        )
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è Lighthouse audit skipped: ${e.message}"
                    }
                }
            }
        }
    }
    
    post {
        always {
            // Limpieza
            cleanWs()
            
            // Notificaci√≥n
            script {
                def message = "React Build ${currentBuild.result ?: 'SUCCESS'} - ${env.JOB_NAME} #${env.BUILD_NUMBER}"
                
                // Slack notification
                slackSend(
                    channel: '#frontend-builds',
                    message: message,
                    color: currentBuild.result == 'SUCCESS' ? 'good' : 'danger'
                )
                
                // Email notification para failures
                if (currentBuild.result == 'FAILURE') {
                    emailext (
                        subject: "‚ùå Build Failed - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                        body: """
                            Proyecto: ${env.JOB_NAME}
                            Build: #${env.BUILD_NUMBER}
                            Estado: FAILED
                            Rama: ${env.BRANCH_NAME}
                            Commit: ${env.GIT_COMMIT.take(8)}
                            URL: ${env.BUILD_URL}
                        """,
                        to: "frontend-team@example.com",
                        attachLog: true
                    )
                }
            }
        }
        
        success {
            echo "üéâ Pipeline de React ejecutada exitosamente!"
            script {
                if (env.BRANCH_NAME == 'main') {
                    slackSend(
                        channel: '#deployments',
                        message: "‚úÖ React App desplegada en producci√≥n: http://${DEPLOY_SERVER}",
                        color: 'good'
                    )
                }
            }
        }
        
        failure {
            echo "üí• Pipeline fall√≥ - Revisar logs"
        }
        
        unstable {
            echo "‚ö†Ô∏è  Build inestable - Problemas de calidad de c√≥digo"
        }
    }
}